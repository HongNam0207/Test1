@page "/monitor"
@using Microsoft.AspNetCore.SignalR.Client
@using BUS.Model
@inject BUS.Services.BusDataService Data
@inject NavigationManager Nav
@inject IJSRuntime JS
@implements IAsyncDisposable

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3 bg-dark text-white p-2 rounded shadow">
        <h3 class="m-0">Hệ thống Giám sát Vận hành (Real-time)</h3>
        <span class="badge bg-outline-light border">Tab ID: @TabId</span>
    </div>

    <div class="row">
        <div class="col-md-9">
            @* Luôn bọc bản đồ trong một div có ID cố định *@
            <div id="map" style="height: 650px; width: 100%; background: #f8f9fa;" class="border shadow rounded"></div>
        </div>

        <div class="col-md-3">
            <div class="card shadow mb-3">
                <div class="card-header bg-primary text-white">Kết nối hệ thống</div>
                <div class="card-body">
                    <p class="mb-0">
                        Trạng thái Hub:
                        <span class="@(hubConnection?.State == HubConnectionState.Connected ? "text-success fw-bold" : "text-danger fw-bold")">
                            ● @(hubConnection?.State.ToString() ?? "Chưa khởi tạo")
                        </span>
                    </p>
                </div>
            </div>

            <div class="card shadow mb-3" style="max-height: 400px; overflow-y: auto;">
                <div class="card-header bg-secondary text-white">Trạng thái đội xe</div>
                <ul class="list-group list-group-flush">
                    @if (Data?.Trips != null)
                    {
                        @foreach (var trip in Data.Trips)
                        {
                            <li class="list-group-item">
                                <strong>@trip.RouteName</strong>
                                <span class="badge bg-info float-end">@trip.Status</span>
                            </li>
                        }
                    }
                </ul>
            </div>
        </div>
    </div>
</div>

@code {
    private string TabId = Guid.NewGuid().ToString().Substring(0, 8);
    private HubConnection? hubConnection;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // 1. Khởi tạo bản đồ
                await JS.InvokeVoidAsync("initMap", 21.0285, 105.8542);

                // 2. Cấu hình Hub
                hubConnection = new HubConnectionBuilder()
                    .WithUrl(Nav.ToAbsoluteUri("/triphub"))
                    .WithAutomaticReconnect()
                    .Build();

                // 3. Xử lý nhận GPS (Sửa lỗi Dispatcher Thread)
                hubConnection.On<int, double, double>("ReceiveGps", async (tripId, lat, lng) =>
                {
                    var trip = Data.Trips.FirstOrDefault(t => t.Id == tripId);
                    string name = trip?.RouteName ?? "Unknown";

                    // QUAN TRỌNG: Mọi cập nhật UI/JS từ SignalR phải bọc trong InvokeAsync
                    await InvokeAsync(async () =>
                    {
                        await JS.InvokeVoidAsync("updateMultiBusLocation", tripId, lat, lng, name);
                        StateHasChanged();
                    });
                });

                await hubConnection.StartAsync();
                await InvokeAsync(StateHasChanged); // Cập nhật trạng thái "Connected" lên màn hình
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Lỗi Monitor: {ex.Message}");
            }
        }
    }

    public async ValueTask DisposeAsync()
    {
        // QUAN TRỌNG: Kiểm tra null để tránh lỗi NullReferenceException (Hình image_f0bcba.png)
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}