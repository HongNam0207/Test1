@page "/monitor"
@using Microsoft.AspNetCore.SignalR.Client
@using BUS.Model
@inject BUS.Services.BusDataService Data
@inject NavigationManager Nav
@inject IJSRuntime JS
@implements IAsyncDisposable

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3 bg-dark text-white p-2 rounded shadow">
        <h3 class="m-0">Hệ thống Giám sát Vận hành (Real-time)</h3>
        <span class="badge bg-outline-light border">Tab ID: @TabId</span>
    </div>

    <div class="row">
        <div class="col-md-9">
            @* Bản đồ được bọc trong một div có ID cố định *@
            <div id="map" style="height: 650px; width: 100%; background: #f8f9fa;" class="border shadow rounded"></div>
        </div>

        <div class="col-md-3">
            <div class="card shadow mb-3">
                <div class="card-header bg-primary text-white">Kết nối hệ thống</div>
                <div class="card-body">
                    <p class="mb-0">
                        Trạng thái Hub:
                        <span class="@(hubConnection?.State == HubConnectionState.Connected ? "text-success fw-bold" : "text-danger fw-bold")">
                            ● @(hubConnection?.State.ToString() ?? "Chưa khởi tạo")
                        </span>
                    </p>
                </div>
            </div>

            <div class="card shadow mb-3" style="max-height: 400px; overflow-y: auto;">
                <div class="card-header bg-secondary text-white">Trạng thái đội xe</div>
                <ul class="list-group list-group-flush">
                    @if (Data?.Trips != null)
                    {
                        @foreach (var trip in Data.Trips)
                        {
                            <li class="list-group-item">
                                <strong>@trip.RouteName</strong>
                                <span class="badge bg-info float-end">@trip.Status</span>
                            </li>
                        }
                    }
                </ul>
            </div>
        </div>
    </div>
</div>

@code {
    private string TabId = Guid.NewGuid().ToString().Substring(0, 8);
    private HubConnection? hubConnection;
    private Dictionary<int, string> tripStatus = new();  // Để lưu trạng thái các chuyến đi

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // 1. Khởi tạo bản đồ
                await JS.InvokeVoidAsync("initMap", 21.0285, 105.8542);

                // 2. Thiết lập SignalR
                hubConnection = new HubConnectionBuilder()
                    .WithUrl(Nav.ToAbsoluteUri("/triphub"))
                    .WithAutomaticReconnect()
                    .Build();

                // 3. Lắng nghe tọa độ GPS từ server
                hubConnection.On<int, double, double>("ReceiveGps", async (tripId, lat, lng) =>
                {
                    // Tìm chuyến đi theo tripId
                    var trip = Data.Trips.FirstOrDefault(t => t.Id == tripId);
                    string routeName = trip?.RouteName ?? "Unknown";

                    // Cập nhật vị trí xe và trạng thái
                    await InvokeAsync(async () =>
                    {
                        await JS.InvokeVoidAsync("updateMultiBusLocation", tripId, lat, lng, routeName);
                        tripStatus[tripId] = "Đang di chuyển";  // Cập nhật trạng thái chuyến đi
                        StateHasChanged();
                    });
                });

                // 4. Lắng nghe cập nhật trạng thái ghế
                hubConnection.On<int, string, string>("ReceiveSeatUpdate", (id, seatNo, status) =>
                {
                    // Cập nhật trạng thái ghế
                    InvokeAsync(() =>
                    {
                        tripStatus[id] = $"Ghế {seatNo} {status}";
                        StateHasChanged();
                    });
                });

                await Connect();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Lỗi Monitor: {ex.Message}");
            }
        }
    }

    private async Task Connect()
    {
        if (hubConnection != null && hubConnection.State == HubConnectionState.Disconnected)
        {
            try
            {
                await hubConnection.StartAsync();
                Console.WriteLine("Kết nối SignalR thành công");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Lỗi kết nối: {ex.Message}");
            }
        }
    }

    private async Task Disconnect()
    {
        if (hubConnection != null && hubConnection.State != HubConnectionState.Disconnected)
        {
            await hubConnection.StopAsync();
            Console.WriteLine("Đã ngắt kết nối SignalR");
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}
